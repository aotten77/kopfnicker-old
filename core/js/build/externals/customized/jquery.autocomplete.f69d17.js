define(["jquery"],function(a){a.autocomplete=function(b,c){function d(){G={},G.data={},G.length=0}function e(){if(46==I||I>8&&32>I)return C.hide();var a=y.val();a!=E&&(E=a,a.length>=c.minChars?(y.addClass(c.loadingClass),q(a)):(y.removeClass(c.loadingClass),C.hide()))}function f(b){var c,d=a("li",B);d&&(F+=b,0>F?F=0:F>=d.size()&&(F=d.size()-1),d.removeClass("ac_over"),a(d[F]).addClass("ac_over"),c=a(d[F]).text(),A.val(c),y.val(c.substring(0,y.val().length)))}function g(){var b=a("li.ac_over",B)[0];if(!b){var d=a("li",B);c.selectOnly?1==d.length&&(b=d[0]):c.selectFirst&&(b=d[0])}return b?(h(b),!0):!1}function h(d){d||(d=document.createElement("li"),d.extra=[],d.selectValue="");var e=a.trim(d.selectValue?d.selectValue:d.innerHTML);e=e.replace(/(<.*?>)/gi,""),b.lastSelected=e,E=e,C.html(""),y.val(e),m(),c.submitForm&&$(c.formID).submit(),c.onItemSelect&&setTimeout(function(){c.onItemSelect(d)},1)}function i(a,b){var c=y.get(0);if(c.createTextRange){var d=c.createTextRange();d.collapse(!0),d.moveStart("character",a),d.moveEnd("character",b),d.select()}else c.setSelectionRange?c.setSelectionRange(a,b):c.selectionStart&&(c.selectionStart=a,c.selectionEnd=b);c.focus()}function j(a){8!=I&&(y.val(y.val()+a.substring(E.length)),i(E.length,a.length))}function k(){var a=w(b),d=c.width>0?c.width:y.width(),e={width:parseInt(d)+"px",top:a.y+b.offsetHeight+"px",left:a.x+c.offsetLeft+"px"};c.jmzindex&&$.extend(!0,e,{"z-index":c.jmzindex}),C.css(e).show(),f(1)}function l(){D&&clearTimeout(D),D=setTimeout(m,200)}function m(){if(D&&clearTimeout(D),y.removeClass(c.loadingClass),C.is(":visible")&&C.hide(),c.mustMatch){var d=y.val();d!=b.lastSelected&&h(null)}a("li",B).removeClass("ac_over"),y.siblings('[disabled="disabled"]').val("")}function n(a,b){if(b){if(y.removeClass(c.loadingClass),B.innerHTML="",!H||0==b.length)return m();B.appendChild(p(b)),c.autoFill&&y.val().toLowerCase()==a.toLowerCase()&&j(b[0][0]),k()}else m();c.jmhideByResult!==!1&&b.length===c.jmhideByResult&&C.is(":visible")&&C.hide()}function o(b){if(!b)return null;for(var d=[],e=b.toString().split(c.lineSeparator),f=0;f<e.length;f++){var g=a.trim(e[f]);g&&(d=g.toString().split(c.cellSeparator))}return d}function p(b){var d=document.createElement("ul"),e=b.length;c.maxItemsToShow>0&&c.maxItemsToShow<e&&(e=c.maxItemsToShow);for(var f=0;e>f;f++){var g=b[f];if(g){var i=document.createElement("li");c.formatItem?(i.innerHTML=c.formatItem(g,f,e),i.selectValue=g[0]):(i.innerHTML=g,i.selectValue=g);var j=null;if(g.length>1){j=[];for(var k=1;k<g.length;k++)j[j.length]=g[k]}i.extra=j,d.appendChild(i),a(i).hover(function(){a("li",d).removeClass("ac_over"),a(this).addClass("ac_over"),F=a("li",d).indexOf(a(this).get(0))},function(){a(this).removeClass("ac_over")}).click(function(a){a.preventDefault(),a.stopPropagation(),h(this)})}}return d}function q(b){c.matchCase||(b=b.toLowerCase());var d=c.cacheLength?s(b):null;d?n(b,d):"string"==typeof c.url&&c.url.length>0&&b.length>=c.minChars?a.get(r(b),function(a){a=o(a),v(b,a),n(b,a)}):y.removeClass(c.loadingClass)}function r(a){var b=c.url+"?q="+encodeURI(a);c.zipCodeBool&&(b+="&zipCode="+y.data("modules.formcomponents.autocomplete").getZipCode());for(var d in c.extraParams)b+="&"+d+"="+encodeURI(c.extraParams[d]);return b}function s(a){if(!a)return null;if(G.data[a])return G.data[a];if(c.matchSubset)for(var b=a.length-1;b>=c.minChars;b--){var d=a.substr(0,b),e=G.data[d];if(e){for(var f=[],g=0;g<e.length;g++){var h=e[g],i=h[0];t(i,a)&&(f[f.length]=h)}return f}}return null}function t(a,b){c.matchCase||(a=a.toLowerCase());var d=a.indexOf(b);return-1==d?!1:0==d||c.matchContains}function u(a,b){b&&y.removeClass(c.loadingClass);for(var d=b?b.length:0,e=null,f=0;d>f;f++){var g=b[f];if(g[0].toLowerCase()==a.toLowerCase()){e=document.createElement("li"),c.formatItem?(e.innerHTML=c.formatItem(g,f,d),e.selectValue=g[0]):(e.innerHTML=g[0],e.selectValue=g[0]);var h=null;if(g.length>1){h=[];for(var i=1;i<g.length;i++)h[h.length]=g[i]}e.extra=h}}c.onFindValue&&setTimeout(function(){c.onFindValue(e)},1)}function v(a,b){b&&a&&c.cacheLength&&(!G.length||G.length>c.cacheLength?(d(),G.length++):G[a]||G.length++,G.data[a]=b)}function w(a){for(var b=a.offsetLeft||0,c=a.offsetTop||0;a=a.offsetParent;)b+=a.offsetLeft,c+=a.offsetTop;return{x:b,y:c}}var x=this,y=a(b).attr("autocomplete","off"),z=y.siblings(".userinput"),A=y.siblings(".behind");c.inputClass&&y.addClass(c.inputClass);var B=document.createElement("div"),C=a(B);C.hide().addClass(c.resultsClass).css("position","absolute"),c.width>0&&C.css("width",c.width),c.jmappendToClass?a("."+c.jmappendToClass).eq(0).append(B):a("body").append(B),b.autocompleter=x;var D=null,E="",F=-1,G={},H=!1,I=null;if(d(),null!=c.data){var J="",K={},L=[];"string"!=typeof c.url&&(c.cacheLength=1);for(var M=0;M<c.data.length;M++)L="string"==typeof c.data[M]?[c.data[M]]:c.data[M],L[0].length>0&&(J=L[0].substring(0,1).toLowerCase(),K[J]||(K[J]=[]),K[J].push(L));for(var N in K)c.cacheLength++,v(N,K[N])}y.on("click touchstart",function(a){0!==A.val().length&&g()&&a.preventDefault()}),y.keydown(function(b){switch(I=b.keyCode,b.keyCode){case 38:b.preventDefault(),f(-1);break;case 40:b.preventDefault(),f(1);break;case 9:case 13:case 39:if(0===A.val().length)break;g()&&13===b.keyCode&&(y.get(0).blur(),b.preventDefault(),""!==c.jmnextFocusNameAttr&&a('[name="'+c.jmnextFocusNameAttr+'"]').focus());break;default:z.val(),F=-1,D&&clearTimeout(D),D=setTimeout(function(){e()},c.delay),setTimeout(function(){y.val().length>z.val().length&&z.val(A.val().substring(0,y.val().length)),""!==A.val()&&A.val().substring(0,y.val().length)!==y.val()&&A.val("")},0)}}).focus(function(){H=!0}).blur(function(){H=!1,l()}),m(),this.flushCache=function(){d()},this.setExtraParams=function(a){c.extraParams=a},this.findValue=function(){var b=y.val();c.matchCase||(b=b.toLowerCase());var d=c.cacheLength?s(b):null;d?u(b,d):"string"==typeof c.url&&c.url.length>0&&b.length>=c.minChars?a.get(r(b),function(a){a=o(a),v(b,a),u(b,a)}):u(b,null)}},a.fn.autocomplete=function(b,c,d){return c=c||{},c.url=b,c.data="object"==typeof d&&d.constructor==Array?d:null,c.inputClass=c.inputClass||"ac_input",c.resultsClass=c.resultsClass||"ac_results",c.lineSeparator=c.lineSeparator||"\n",c.cellSeparator=c.cellSeparator||",",c.minChars=c.minChars||2,c.delay=c.delay||400,c.matchCase=c.matchCase||0,c.matchSubset=c.matchSubset||1,c.matchContains=c.matchContains||0,c.cacheLength=c.cacheLength||null,c.mustMatch=c.mustMatch||0,c.extraParams=c.extraParams||{},c.loadingClass=c.loadingClass||"ac_loading",c.selectFirst=c.selectFirst||!1,c.selectOnly=c.selectOnly||!1,c.maxItemsToShow=c.maxItemsToShow||10,c.autoFill=c.autoFill||!1,c.width=parseInt(c.width,10)||0,c.offsetLeft=c.offsetLeft||0,c.submitForm=c.submitForm||!1,c.formID=c.formID||"",c.jmhideByResult=c.jmhideByResult||!1,c.jmzindex=c.jmzindex||!1,c.jmappendToClass=c.jmappendToClass||!1,c.jmnextFocusNameAttr=c.jmnextFocusNameAttr||"",this.each(function(){var b=this;new a.autocomplete(b,c)}),this},a.fn.autocompleteArray=function(a,b){return this.autocomplete(null,b,a)},a.fn.indexOf=function(a){for(var b=0;b<this.length;b++)if(this[b]==a)return b;return-1}});